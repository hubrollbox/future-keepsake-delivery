name: "üìù Criar Rascunho de Blog (AI)"

on:
  workflow_dispatch:
    inputs:
      topic_id:
        description: "ID do tema a gerar (ex: topic-001)"
        required: true
        type: string
      ai_model:
        description: "Modelo de IA a usar"
        required: false
        default: "google/gemini-3-flash-preview"
        type: choice
        options:
          - "google/gemini-3-flash-preview"
          - "google/gemini-2.5-flash"
          - "gpt-4o-mini"
          - "gpt-4o"
      dry_run:
        description: "Dry run (n√£o cria PR, apenas gera o ficheiro)"
        required: false
        default: false
        type: boolean

jobs:
  generate-draft:
    name: "Gerar Rascunho Editorial"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: "üì• Checkout do c√≥digo"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "üü¢ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: "üì¶ Instalar depend√™ncias"
        run: npm ci

      - name: "üîç Listar temas dispon√≠veis"
        run: |
          echo "=== Temas dispon√≠veis no banco editorial ==="
          npx ts-node scripts/editorial/selectTopic.ts list por_escrever || true

      - name: "ü§ñ Gerar rascunho com IA"
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_BASE_URL: ${{ vars.AI_BASE_URL || 'https://ai.gateway.lovable.dev/v1' }}
          AI_MODEL: ${{ inputs.ai_model }}
        run: |
          echo "=== A gerar rascunho para tema: ${{ inputs.topic_id }} ==="
          npx ts-node scripts/editorial/generateDraft.ts ${{ inputs.topic_id }}

      - name: "üìÑ Formatar draft em Markdown"
        run: |
          npx ts-node scripts/editorial/formatDraft.ts ${{ inputs.topic_id }}
          echo "=== Ficheiros na pasta drafts/ ==="
          ls -la scripts/editorial/drafts/ || echo "Pasta vazia"

      - name: "üìå Resolver ficheiro gerado"
        id: resolve-draft
        run: |
          DRAFT_FILE=$(find scripts/editorial/drafts -maxdepth 1 -type f -name '*.md' -print0 | xargs -0 ls -1t 2>/dev/null | head -n 1)
          if [ -z "$DRAFT_FILE" ]; then
            echo "‚ùå Nenhum ficheiro de draft encontrado!"
            exit 1
          fi

          echo "draft_file=$DRAFT_FILE" >> "$GITHUB_OUTPUT"
          echo "Draft resolvido: $DRAFT_FILE"

      - name: "‚úÖ Validar ficheiro gerado"
        run: |
          DRAFT_FILE="${{ steps.resolve-draft.outputs.draft_file }}"
          echo "A validar: $DRAFT_FILE"
          npx ts-node scripts/editorial/formatDraft.ts validate "$DRAFT_FILE"

      - name: "üìä Mostrar resumo do draft"
        run: |
          DRAFT_FILE="${{ steps.resolve-draft.outputs.draft_file }}"
          echo "=== RESUMO DO DRAFT GERADO ==="
          echo "Ficheiro: $DRAFT_FILE"
          wc -w "$DRAFT_FILE" | awk '{print "Palavras (aprox.):", $1}'
          echo ""
          echo "=== FRONTMATTER ==="
          head -30 "$DRAFT_FILE"

      - name: "üîÄ Criar Pull Request"
        if: ${{ !inputs.dry_run }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat(blog): rascunho gerado para '${{ inputs.topic_id }}'"
          title: "üìù Conte√∫do: ${{ inputs.topic_id }} ‚Äî Aguarda Revis√£o Editorial"
          body: |
            ## üìù Rascunho de Blog Gerado por IA

            **Tema ID:** `${{ inputs.topic_id }}`
            **Modelo de IA:** `${{ inputs.ai_model }}`
            **Gerado em:** ${{ github.event.head_commit.timestamp || 'agora' }}

            ---

            ### ‚úÖ Checklist de Revis√£o Editorial

            Antes de fazer merge, a equipa editorial deve verificar:

            - [ ] **Conte√∫do**: Leu e aprovou o artigo completo
            - [ ] **Factos**: Verificou todos os dados e refer√™ncias mencionados
            - [ ] **Tom**: O texto soa √† voz Keepla (c√°lido, aut√™ntico, pr√≥ximo)
            - [ ] **SEO**: A palavra-chave principal aparece naturalmente no texto
            - [ ] **Imagem de capa**: Fez upload no Supabase Storage e atualizou `cover_image_url`
            - [ ] **Excerpt**: √â apelativo e tem menos de 160 caracteres
            - [ ] **Status**: Alterou `status: draft` para `status: published` quando pronto

            ---

            ### üöÄ Ap√≥s o merge

            O workflow `sync-blog-to-supabase.yml` ir√° sincronizar automaticamente o post com o Supabase. Se `status: published`, o post fica vis√≠vel no blog imediatamente.

            ---

            *Gerado automaticamente pelo sistema editorial Keepla.*
          branch: "blog/draft-${{ inputs.topic_id }}-${{ github.run_id }}"
          base: main
          labels: |
            blog-draft
            revisao-editorial
            ai-generated
          draft: false

      - name: "‚ÑπÔ∏è Dry run ‚Äî sem PR criado"
        if: ${{ inputs.dry_run }}
        run: |
          echo "=== DRY RUN ATIVO ==="
          echo "Ficheiro gerado mas PR N√ÉO criado."
          echo "Para criar o PR, execute o workflow sem o dry_run ativo."
