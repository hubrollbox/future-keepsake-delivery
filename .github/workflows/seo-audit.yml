name: "ğŸ“Š Auditoria SEO Mensal do Blog"

on:
  # Corre automaticamente no 1.Âº dia de cada mÃªs Ã s 9:00 UTC
  schedule:
    - cron: "0 9 1 * *"

  # Pode ser acionado manualmente a qualquer momento
  workflow_dispatch:
    inputs:
      generate_report:
        description: "Gerar relatÃ³rio Markdown e criar PR"
        required: false
        default: true
        type: boolean

jobs:
  seo-audit:
    name: "Auditoria SEO"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4

      - name: "ğŸŸ¢ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: "ğŸ“¦ Instalar dependÃªncias"
        run: npm ci

      - name: "ğŸ” Executar auditoria SEO"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          npx ts-node scripts/editorial/seoAudit.ts --report

      - name: "ğŸ“Š Criar PR com relatÃ³rio"
        if: ${{ inputs.generate_report != false }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs(seo): relatÃ³rio de auditoria SEO mensal"
          title: "ğŸ“Š Insights SEO â€” ${{ github.event.schedule && 'RelatÃ³rio Mensal' || 'Auditoria Manual' }}"
          body: |
            ## ğŸ“Š RelatÃ³rio de Auditoria SEO â€” Blog Keepla

            Este relatÃ³rio foi gerado automaticamente pelo sistema de auditoria SEO.

            **Quando:** ${{ github.event.schedule && 'Agendado (1.Âº do mÃªs)' || 'Acionado manualmente por ' }}${{ github.actor }}

            ### O que encontrarÃ¡ no relatÃ³rio:
            - Score SEO de cada post publicado
            - Issues crÃ­ticos a resolver
            - SugestÃµes de melhoria por post
            - RecomendaÃ§Ãµes editoriais para o prÃ³ximo mÃªs

            ### PrÃ³ximos passos:
            1. Rever o relatÃ³rio em `scripts/editorial/reports/`
            2. Identificar os posts com menor score
            3. Planear melhorias no banco editorial
            4. Fazer merge quando o relatÃ³rio estiver revisto

            ---
            *Gerado automaticamente pelo sistema editorial Keepla.*
          branch: "seo/audit-${{ github.run_id }}"
          base: main
          labels: |
            seo-audit
            editorial
